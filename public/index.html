<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WarpGen ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä WARP –¥–ª—è AmneziaWG 2.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0a0d14;
      --surface: rgba(255, 255, 255, 0.04);
      --border: rgba(255, 255, 255, 0.08);
      --accent: #7c6bdb;
      --accent2: #4fc3f7;
      --success: #4ade80;
      --danger: #f87171;
      --text: #e2e8f0;
      --muted: #64748b;
      --radius: 14px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 16px 80px;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -10%, rgba(124, 107, 219, 0.18) 0%, transparent 70%),
        radial-gradient(ellipse 60% 40% at 80% 80%, rgba(79, 195, 247, 0.08) 0%, transparent 60%);
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      text-align: center;
      margin-bottom: 36px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo svg {
      width: 36px;
      height: 36px;
    }

    .logo-accent {
      color: var(--accent);
    }

    .logo-accent2 {
      color: var(--accent2);
    }

    header p {
      color: var(--muted);
      margin-top: 8px;
      font-size: 14px;
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      width: 100%;
      max-width: 640px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      padding: 28px 28px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* ‚îÄ‚îÄ Form elements ‚îÄ‚îÄ */
    .field {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #94a3b8;
      margin-bottom: 7px;
    }

    input[type="text"],
    select {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 9px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      padding: 11px 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 107, 219, 0.15);
    }

    input[type="text"]::placeholder {
      color: var(--muted);
    }

    select {
      appearance: none;
      cursor: pointer;
    }

    select option {
      background: #1a1f2e;
      color: var(--text);
    }

    select optgroup {
      background: #0f1320;
      color: var(--muted);
      font-style: normal;
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ Grid for selects ‚îÄ‚îÄ */
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media(max-width:480px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    /* ‚îÄ‚îÄ Split tunneling ‚îÄ‚îÄ */
    .split-targets {
      margin-top: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .split-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .split-tool-btn {
      padding: 7px 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      transition: background .2s;
    }

    .split-tool-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* ‚îÄ‚îÄ Local speedtest panel ‚îÄ‚îÄ */
    .speedtest-panel {
      margin-top: 12px;
      background: rgba(124, 107, 219, 0.08);
      border: 1px solid rgba(124, 107, 219, 0.25);
      border-radius: 12px;
      padding: 16px;
    }

    .speedtest-panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .speedtest-panel-icon {
      font-size: 28px;
      line-height: 1;
      flex-shrink: 0;
    }

    .speedtest-panel-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .speedtest-panel-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .speedtest-steps {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    .speedtest-step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
    }

    .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(124, 107, 219, 0.35);
      color: #c4b8ff;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .speedtest-btn {
      display: block;
      width: 100%;
      padding: 12px 20px;
      background: linear-gradient(135deg, #7c6bdb 0%, #5b52b8 100%);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
      letter-spacing: 0.02em;
    }

    .speedtest-btn:hover {
      opacity: 0.88;
    }

    .speedtest-btn:active {
      transform: scale(0.98);
    }

    .speedtest-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .speedtest-dpi-toggle {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      padding: 10px 12px;
      background: rgba(248, 113, 113, 0.07);
      border: 1px solid rgba(248, 113, 113, 0.2);
      border-radius: 8px;
    }

    .speedtest-dpi-toggle input[type="checkbox"] {
      margin-top: 2px;
      flex-shrink: 0;
      width: 15px;
      height: 15px;
      accent-color: #f87171;
      cursor: pointer;
    }

    .speedtest-dpi-label {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
    }

    .speedtest-dpi-label strong {
      color: #fca5a5;
    }

    .speedtest-detail {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .speedtest-detail strong {
      color: rgba(196, 184, 255, 0.8);
    }

    .split-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .split-item {
      display: flex;
      align-items: center;
      gap: 9px;
      margin: 0;
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: background .2s, border-color .2s;
    }

    .split-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(124, 107, 219, 0.45);
    }

    .split-item input[type="checkbox"] {
      width: 15px;
      height: 15px;
      margin: 0;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    .split-note {
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    @media(max-width:640px) {
      .split-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ‚îÄ‚îÄ Generate button ‚îÄ‚îÄ */
    .btn-generate {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent), #5b4fcf);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.2px;
      transition: opacity .2s, transform .15s, box-shadow .2s;
      box-shadow: 0 4px 24px rgba(124, 107, 219, 0.3);
    }

    .btn-generate:hover:not(:disabled) {
      opacity: .9;
      transform: translateY(-1px);
      box-shadow: 0 6px 28px rgba(124, 107, 219, 0.4);
    }

    .btn-generate:active {
      transform: translateY(0);
    }

    .btn-generate:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    /* ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ‚îÄ‚îÄ Result card ‚îÄ‚îÄ */
    #result-card {
      display: none;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 99px;
      text-transform: uppercase;
      letter-spacing: .8px;
    }

    .badge-plus {
      background: rgba(250, 204, 21, 0.15);
      color: #fbbf24;
    }

    .badge-free {
      background: rgba(100, 116, 139, 0.2);
      color: var(--muted);
    }

    #config-output {
      width: 100%;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.65;
      color: #94a3b8;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      resize: vertical;
      min-height: 300px;
      outline: none;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .btn-dl {
      flex: 1;
      min-width: 140px;
      padding: 11px 16px;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 9px;
      color: var(--success);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }

    .btn-dl:hover {
      background: rgba(74, 222, 128, 0.18);
    }

    .btn-copy {
      flex: 1;
      min-width: 140px;
      padding: 11px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 9px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }

    .btn-copy:hover {
      background: rgba(255, 255, 255, 0.09);
    }

    .btn-qr {
      padding: 11px 16px;
      background: rgba(79, 195, 247, 0.08);
      border: 1px solid rgba(79, 195, 247, 0.2);
      border-radius: 9px;
      color: var(--accent2);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }

    .btn-qr:hover {
      background: rgba(79, 195, 247, 0.16);
    }

    /* ‚îÄ‚îÄ Speedtest results ‚îÄ‚îÄ */
    .speedtest-results-title {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .speedtest-results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    .speedtest-results-table th {
      color: var(--muted);
      font-weight: 500;
      text-align: left;
      padding: 3px 6px;
      border-bottom: 1px solid var(--border);
    }

    .speedtest-results-table td {
      padding: 3px 6px;
      color: #94a3b8;
    }

    .speedtest-results-table tr:first-child td {
      color: var(--success);
      font-weight: 600;
    }

    .speedtest-source-tag {
      display: inline-block;
      margin-top: 6px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 20px;
      background: rgba(124, 107, 219, 0.15);
      color: var(--accent);
      border: 1px solid rgba(124, 107, 219, 0.25);
    }

    /* ‚îÄ‚îÄ QR modal ‚îÄ‚îÄ */
    #qr-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #qr-modal.open {
      display: flex;
    }

    .qr-modal-box {
      background: #13172b;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 28px 24px 20px;
      text-align: center;
      max-width: 340px;
      width: 90%;
    }

    .qr-modal-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .qr-modal-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    #qr-canvas {
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .qr-modal-close {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }

    .qr-modal-close:hover { color: var(--text); }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    .error-box {
      display: none;
      padding: 12px 14px;
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.2);
      border-radius: 9px;
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
    }

    /* ‚îÄ‚îÄ Status line ‚îÄ‚îÄ */
    .status-pill {
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
      text-align: center;
    }

    .dns-miss-spoiler {
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
    }

    .dns-miss-spoiler summary {
      cursor: pointer;
      user-select: none;
      color: var(--muted);
      font-size: 12px;
      outline: none;
    }

    .dns-miss-note {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .dns-miss-list {
      margin-top: 8px;
      padding-left: 18px;
      max-height: 180px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.55;
      color: var(--text);
    }

    /* ‚îÄ‚îÄ Config History ‚îÄ‚îÄ */
    #history-card {
      display: none;
      margin-top: 16px;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .history-item:hover { background: rgba(255,255,255,0.07); }
    .history-item-meta { flex: 1; min-width: 0; overflow: hidden; }
    .history-item-title { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .history-item-date { color: var(--muted); margin-top: 2px; font-size: 11px; }
    .history-tag {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      border-radius: 4px;
      padding: 1px 7px;
      font-size: 11px;
      font-weight: 600;
      cursor: default;
    }
    .history-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-shrink: 0;
    }
    .history-btn {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 5px;
      cursor: pointer;
      color: var(--muted);
      background: transparent;
      border: 1px solid transparent;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
      white-space: nowrap;
      user-select: none;
    }
    .history-btn:hover { color: var(--text); background: rgba(255,255,255,0.08); border-color: var(--border); }
    .history-btn-restore { color: var(--accent); }
    .history-btn-restore:hover { color: var(--accent); border-color: var(--accent); background: rgba(99,179,237,0.1); }
    .history-btn-del:hover { color: var(--danger); border-color: var(--danger); background: rgba(220,38,38,0.1); }
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    footer {
      margin-top: 32px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }

    footer a {
      color: var(--accent2);
      text-decoration: none;
    }

    .version-line {
      margin-top: 8px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.55);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .faq-block {
      margin: 14px auto 0;
      max-width: 700px;
      text-align: left;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      padding: 10px 12px;
    }

    .faq-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: #9fb2ce;
      margin-bottom: 8px;
    }

    .faq-item {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 0;
    }

    .faq-item:first-of-type {
      border-top: 0;
      padding-top: 2px;
    }

    .faq-item summary {
      cursor: pointer;
      font-size: 13px;
      color: #d8e4f8;
      list-style: none;
      user-select: none;
    }

    .faq-item summary::-webkit-details-marker {
      display: none;
    }

    .faq-text {
      margin-top: 6px;
      font-size: 12px;
      line-height: 1.55;
      color: var(--muted);
    }

    .secret-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>

  <header>
    <div class="logo" id="logoTrigger" title="WarpGen">
      <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="18" cy="18" r="17" stroke="url(#g1)" stroke-width="2" />
        <path d="M11 18 C11 13 15 10 18 10 C21 10 25 13 25 18 C25 23 21 26 18 26 C16 26 14 25 13 23" stroke="url(#g2)"
          stroke-width="2.2" stroke-linecap="round" />
        <circle cx="18" cy="18" r="4" fill="url(#g1)" />
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="36" y2="36" gradientUnits="userSpaceOnUse">
            <stop stop-color="#7c6bdb" />
            <stop offset="1" stop-color="#4fc3f7" />
          </linearGradient>
          <linearGradient id="g2" x1="10" y1="10" x2="26" y2="26" gradientUnits="userSpaceOnUse">
            <stop stop-color="#7c6bdb" />
            <stop offset="1" stop-color="#4fc3f7" />
          </linearGradient>
        </defs>
      </svg>
      <span>Warp<span class="logo-accent">Gen</span></span>
    </div>
    <p>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥–æ–≤ Cloudflare WARP –¥–ª—è <strong>AmneziaWG 2.0</strong> –∏ <strong>WireGuard</strong></p>
    <div style="margin-top:10px;">
      <a href="/clash" style="display:inline-block; padding:9px 13px; border:1px solid var(--border); border-radius:10px; text-decoration:none; color:var(--text); background:rgba(255,255,255,0.06); font-size:13px;">
        –û—Ç–∫—Ä—ã—Ç—å Clash Configurator (Profile URL)
      </a>
    </div>
  </header>

  <div class="card">
    <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞</div>

    <div class="field">
      <label>–ö–ª—é—á WARP+ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="text" id="licenseKey" placeholder="xxxxxxxx-xxxxxxxx-xxxxxxxx (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ)">
    </div>

    <div class="field">
      <label>–¢–∏–ø –∫–æ–Ω—Ñ–∏–≥–∞</label>
      <select id="configType">
        <option value="amnezia" selected>AmneziaWG / AmneziaVPN (S/J/H/I1)</option>
        <option value="wireguard">WireGuard (vanilla)</option>
        <option value="wiresock">WireSock (WG + DisallowedIPs)</option>
      </select>
      <div class="split-note">
        –î–ª—è —Ä–µ–∂–∏–º–∞ blacklist/direct –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ WireSock.
      </div>
    </div>

    <div class="grid2" id="connectionGrid">
      <div class="field amnezia-only">
        <label>–ü—Ä–æ—Ñ–∏–ª—å –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏</label>
        <select id="obfsProfile">
          <option value="1">Jc=4, Jmin=40, Jmax=70 ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ‚úì</option>
          <option value="2">Jc=120, Jmin=23, Jmax=911 ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</option>
          <option value="3">Jc=10, Jmin=100, Jmax=300 ‚Äî –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π DPI</option>
        </select>
      </div>
      <div class="field">
        <label>–ü–æ—Ä—Ç Endpoint</label>
        <select id="endpointPort"></select>
        <div class="split-note">–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Ä–∞–±–æ—á–∏–µ –ø–æ—Ä—Ç—ã –∏–∑ WARP speedtest –Ω–∞–±–æ—Ä–∞.</div>
      </div>
    </div>

    <div class="field">
      <label>Endpoint IP</label>
      <select id="endpointIp"></select>

      <div class="speedtest-panel">
        <div class="speedtest-panel-header">
          <span class="speedtest-panel-icon">‚ö°</span>
          <div>
            <div class="speedtest-panel-title">–ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –ª—É—á—à–µ–≥–æ endpoint</div>
            <div class="speedtest-panel-sub">–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ WARP IP —Å –≤–∞—à–µ–π —Å–µ—Ç–∏ –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º—É</div>
          </div>
        </div>

        <div class="speedtest-steps" id="speedtest-steps-win">
          <div class="speedtest-step"><span class="step-num">1</span>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äî —Å–∫–∞—á–∞–µ—Ç—Å—è <code>.bat</code>-—Ñ–∞–π–ª</div>
          <div class="speedtest-step"><span class="step-num">2</span>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º (1‚Äì3 –º–∏–Ω)</div>
          <div class="speedtest-step"><span class="step-num">3</span>Endpoint –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
        </div>
        <div class="speedtest-steps" id="speedtest-steps-mac" style="display:none">
          <div class="speedtest-step"><span class="step-num">1</span>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äî —Å–∫–∞—á–∞–µ—Ç—Å—è <code>.sh</code>-—Å–∫—Ä–∏–ø—Ç</div>
          <div class="speedtest-step"><span class="step-num">2</span>–í –¢–µ—Ä–º–∏–Ω–∞–ª–µ: <code>bash ~/Downloads/warp-speedtest-*.sh</code></div>
          <div class="speedtest-step"><span class="step-num">3</span>Endpoint –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
        </div>

        <label class="speedtest-dpi-toggle" id="dpiFirstToggle">
          <input type="checkbox" id="dpiFirstMode">
          <span class="speedtest-dpi-label">
            <strong>–£ –º–µ–Ω—è DPI-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞</strong> ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä—è–º–æ–π —Ç–µ—Å—Ç, —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ö–æ–¥ —á–µ—Ä–µ–∑ zapret
          </span>
        </label>
        <label class="speedtest-dpi-toggle" id="extendedStrategyToggle">
          <input type="checkbox" id="speedtestExtendedMode" checked>
          <span class="speedtest-dpi-label">
            <strong>Extended strategy mode</strong> ‚Äî –±–æ–ª—å—à–µ –ø—Ä–æ—Ñ–∏–ª–µ–π winws + —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ–¥—Å–µ—Ç—è–º (–¥–æ–ª—å—à–µ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ)
          </span>
        </label>

        <button type="button" id="localSpeedtestBtn" class="speedtest-btn" onclick="startLocalSpeedtest()">
          ‚ö° –ü–æ–¥–æ–±—Ä–∞—Ç—å endpoint –ª–æ–∫–∞–ª—å–Ω–æ
        </button>

        <div class="speedtest-detail" id="speedtest-detail-win">
          Windows: —Å–∫–∞—á–∏–≤–∞–µ—Ç <strong>CloudflareWarpSpeedTest</strong>, –ø—Ä–∏ DPI-–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ ‚Äî <strong>zapret/winws</strong>. –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        </div>
        <div class="speedtest-detail" id="speedtest-detail-mac" style="display:none">
          macOS/Linux: —Å–∫–∞—á–∏–≤–∞–µ—Ç <strong>CloudflareWarpSpeedTest</strong> –¥–ª—è –≤–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫–∞–Ω –≤—Å–µ—Ö WARP IP.
        </div>

        <div class="split-note" id="localSpeedtestHint" style="margin-top:6px;"></div>
        <div id="speedtest-results" style="display:none; margin-top:10px;"></div>
      </div>
    </div>

    <div class="field">
      <label>DNS —Å–µ—Ä–≤–µ—Ä</label>
      <select id="dnsServer">
        <optgroup label="üåê –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã">
          <option value="malw_link" selected>dns.malw.link ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤ ‚úì</option>
          <option value="xbox_dns_ru">xbox-dns.ru ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞—Ä—É–±–µ–∂–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</option>
          <option value="dns_geohide_ru">dns.geohide.ru ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞—Ä—É–±–µ–∂–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</option>
          <option value="dns_comss_one">dns.comss.one ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞—Ä—É–±–µ–∂–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</option>
        </optgroup>
        <optgroup label="–ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ">
          <option value="cloudflare">Cloudflare 1.1.1.1 ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π</option>
          <option value="google">Google 8.8.8.8</option>
          <option value="quad9_nofilter">Quad9 9.9.9.10 ‚Äî –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</option>
          <option value="quad9_ecs">Quad9 9.9.9.11 ‚Äî ECS (–±—ã—Å—Ç—Ä–µ–µ CDN)</option>
          <option value="opendns">OpenDNS 208.67.222.222</option>
          <option value="gcore">G-Core 95.85.95.85 ‚Äî EU anycast</option>
          <option value="yandex">–Ø–Ω–¥–µ–∫—Å 77.88.8.8</option>
        </optgroup>
        <optgroup label="üõ° –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∫–ª–∞–º—ã –∏ —Ç—Ä–µ–∫–µ—Ä–æ–≤">
          <option value="adguard">AdGuard DNS ‚Äî —Ä–µ–∫–ª–∞–º–∞ + —Ç—Ä–µ–∫–µ—Ä—ã</option>
          <option value="adguard_nofilter">AdGuard DNS ‚Äî –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</option>
          <option value="nextdns">NextDNS ‚Äî —Ä–µ–∫–ª–∞–º–∞ + —Ç—Ä–µ–∫–µ—Ä—ã</option>
          <option value="cloudflare_mal">Cloudflare 1.1.1.2 ‚Äî —Ç–æ–ª—å–∫–æ –º–∞–ª–≤–∞—Ä—å</option>
          <option value="quad9">Quad9 9.9.9.9 ‚Äî –º–∞–ª–≤–∞—Ä—å + —Ñ–∏—à–∏–Ω–≥</option>
        </optgroup>
        <optgroup label="üë®‚Äçüë©‚Äçüëß –°–µ–º–µ–π–Ω—ã–π (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö)">
          <option value="adguard_family">AdGuard Family</option>
          <option value="yandex_safe">–Ø–Ω–¥–µ–∫—Å Safe ‚Äî —Ñ–∏—à–∏–Ω–≥</option>
          <option value="yandex_family">–Ø–Ω–¥–µ–∫—Å Family ‚Äî 18+</option>
          <option value="opendns_family">OpenDNS Family Shield</option>
        </optgroup>
        <optgroup label="üîí Privacy / –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ">
          <option value="mullvad">Mullvad ‚Äî –±–µ–∑ –ª–æ–≥–æ–≤, –±–µ–∑ —Ä–µ–∫–ª–∞–º—ã</option>
          <option value="dnssb">DNS.SB ‚Äî –®–≤–µ–π—Ü–∞—Ä–∏—è, –±–µ–∑ –ª–æ–≥–æ–≤</option>
          <option value="dns0eu">dns0.eu ‚Äî –ï–≤—Ä–æ–ø–∞, GDPR</option>
        </optgroup>
      </select>
    </div>

    <div class="field amnezia-only">
      <label>–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ (I1)</label>
      <select id="quicPreset">
        <option value="random">üé≤ –°–ª—É—á–∞–π–Ω—ã–π –∏–∑ –≤—Å–µ—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤</option>
        <optgroup label="‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç—ã (—Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫)">
          <option value="warpgen">QUIC ‚Äî warpgen.net –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="ya_ru_capture">QUIC ‚Äî ya.ru –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="cloudflare_capture">QUIC ‚Äî Cloudflare –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="google_capture">QUIC ‚Äî Google –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="capture_195_85_59_162">QUIC ‚Äî 195.85.59.162 –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="capture_87_245_197_142">QUIC ‚Äî 87.245.197.142 –∑–∞—Ö–≤–∞—Ç ‚úì</option>
          <option value="yandex" selected>DNS ‚Äî –Ø–Ω–¥–µ–∫—Å/–ö–∏–Ω–æ–ø–æ–∏—Å–∫ –∑–∞—Ö–≤–∞—Ç ‚úì (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
          <option value="dns_web_max_ru">DNS ‚Äî web.max.ru –∑–∞—Ö–≤–∞—Ç ‚úì</option>
        </optgroup>
        <optgroup label="DNS –æ—Ç–≤–µ—Ç (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Äî –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç)">
          <option value="dns_ya">DNS ‚Üí ya.ru ‚òÖ (–ª—É—á—à–µ –¥–ª—è –¢–°–ü–£)</option>
          <option value="dns_vk">DNS ‚Üí vk.com ‚òÖ</option>
          <option value="dns_ozon">DNS ‚Üí ozon.ru ‚òÖ</option>
          <option value="dns_rutube">DNS ‚Üí rutube.ru</option>
          <option value="dns_google">DNS ‚Üí google.com</option>
          <option value="dns_youtube">DNS ‚Üí youtube.com</option>
        </optgroup>
        <optgroup label="STUN / NTP / DTLS (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã)">
          <option value="stun">STUN ‚Äî WebRTC/VoIP —Ç—Ä–∞—Ñ–∏–∫</option>
          <option value="ntp">NTP ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏</option>
          <option value="dtls">DTLS 1.2 ‚Äî WebRTC –º–µ–¥–∏–∞</option>
        </optgroup>
        <optgroup label="QUIC v1 ‚Äî —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã">
          <option value="ya">QUIC ‚Üí ya.ru</option>
          <option value="rutube">QUIC ‚Üí rutube.ru</option>
          <option value="ozon">QUIC ‚Üí ozon.ru</option>
          <option value="vk">QUIC ‚Üí vk.com</option>
          <option value="ok">QUIC ‚Üí ok.ru</option>
          <option value="mail">QUIC ‚Üí mail.ru</option>
          <option value="gosuslugi">QUIC ‚Üí gosuslugi.ru</option>
          <option value="sberbank">QUIC ‚Üí sberbank</option>
          <option value="dzen">QUIC ‚Üí dzen.ru</option>
          <option value="wildberries">QUIC ‚Üí wildberries.ru</option>
          <option value="avito">QUIC ‚Üí avito.ru</option>
          <option value="mos">QUIC ‚Üí mos.ru</option>
          <option value="nalog">QUIC ‚Üí nalog.gov.ru</option>
        </optgroup>
        <optgroup label="QUIC v1 ‚Äî –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã">
          <option value="google">QUIC ‚Üí google.com</option>
          <option value="youtube">QUIC ‚Üí youtube.com</option>
          <option value="apple">QUIC ‚Üí apple.com</option>
          <option value="microsoft">QUIC ‚Üí microsoft.com</option>
          <option value="amazon">QUIC ‚Üí amazon.com</option>
          <option value="discord">QUIC ‚Üí discord.com</option>
          <option value="twitch">QUIC ‚Üí twitch.tv</option>
          <option value="whatsapp">QUIC ‚Üí whatsapp.com</option>
          <option value="zoom">QUIC ‚Üí zoom.us</option>
          <option value="skype">QUIC ‚Üí skype.com</option>
          <option value="steam">QUIC ‚Üí steam</option>
          <option value="github">QUIC ‚Üí github.com</option>
        </optgroup>
        <option value="none">–ë–µ–∑ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏</option>
      </select>
    </div>

    <div class="field wiresock-only" style="display:none;">
      <label>Protocol masking (WireSock)</label>
      <div class="grid2">
        <div class="field" style="margin-bottom:0;">
          <label style="margin-top:2px;">–†–µ–∂–∏–º</label>
          <select id="protocolMaskingEnabled">
            <option value="0" selected>–í—ã–∫–ª—é—á–µ–Ω–æ</option>
            <option value="1">–í–∫–ª—é—á–µ–Ω–æ</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:0;">
          <label style="margin-top:2px;">Id (–¥–æ–º–µ–Ω)</label>
          <input type="text" id="protocolMaskId" value="lenta.ru" placeholder="lenta.ru">
        </div>
        <div class="field" style="margin-bottom:0;">
          <label style="margin-top:2px;">Ip (–ø—Ä–æ—Ç–æ–∫–æ–ª)</label>
          <select id="protocolMaskIp">
            <option value="quic" selected>quic</option>
            <option value="tls">tls</option>
            <option value="https">https</option>
            <option value="http2">http2</option>
            <option value="dtls">dtls</option>
            <option value="stun">stun</option>
            <option value="random">random</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:0;">
          <label style="margin-top:2px;">Ib (–∫–ª–∏–µ–Ω—Ç)</label>
          <select id="protocolMaskIb">
            <option value="firefox" selected>firefox</option>
            <option value="chrome">chrome</option>
            <option value="edge">edge</option>
            <option value="safari">safari</option>
            <option value="android">android</option>
            <option value="ios">ios</option>
            <option value="random">random</option>
          </select>
        </div>
      </div>
      <div class="split-note">
        –î–æ–±–∞–≤–∏—Ç —Å–µ–∫—Ü–∏—é <code># Protocol masking</code> —Å –ø–æ–ª—è–º–∏ <code>Id/Ip/Ib</code> –≤ WireSock-–∫–æ–Ω—Ñ–∏–≥.
      </div>
    </div>

    <div class="field">
      <label>–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞</label>
      <select id="splitMode">
        <option value="full" selected>–í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ VPN (Full Tunnel)</option>
        <option value="selective">–¢–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ VPN (Split Tunnel)</option>
        <option value="blacklist">–í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ VPN, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤ DIRECT (Blacklist)</option>
      </select>
      <div class="split-note">
        Split tunnel —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ IP/–ø–æ–¥—Å–µ—Ç—è–º: –¥–æ–º–µ–Ω—ã —Ä–µ–∑–æ–ª–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞. Blacklist/direct –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ WireSock.
      </div>

      <div id="splitTargetsWrap" class="split-targets" style="display:none;">
        <div class="split-tools">
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('social')">–ß–∞—Å—Ç–æ –Ω—É–∂–Ω–æ</button>
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('gaming')">–ò–≥—Ä—ã</button>
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('ai')">AI / –ù–µ–π—Ä–æ—Å–µ—Ç–∏</button>
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('ru_direct')">geosite:ru</button>
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('all')">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
          <button type="button" class="split-tool-btn" onclick="applySplitPreset('clear')">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="split-grid">
          <label class="split-item"><input type="checkbox" data-split-target value="discord"><span>Discord</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="youtube"><span>YouTube</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="x_com"><span>X.com</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="instagram"><span>Instagram</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="twitch"><span>Twitch</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="telegram"><span>Telegram</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="steam"><span>Steam</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="faceit"><span>FACEIT</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="whatsapp"><span>WhatsApp</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="viber"><span>Viber</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="jetbrains"><span>JetBrains (+ CDN)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="tiktok"><span>TikTok</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="ipcheck_2ip"><span>2IP (2ip.ru / 2ip.io)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="speedtest"><span>Speedtest.com</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="fast_com"><span>Fast.com</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="whoer"><span>Whoer.net</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="geosite_ru"><span>geosite:ru (core)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="apex_legends"><span>Apex Legends</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="ea_app"><span>EA App</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="battle_net"><span>Battle.net</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="cs2"><span>CS2</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="hearthstone"><span>Hearthstone</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="pubg"><span>PUBG</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="chatgpt"><span>ChatGPT (OpenAI)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="claude_ai"><span>Claude (Anthropic)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="gemini"><span>Gemini (Google AI)</span></label>
          <label class="split-item"><input type="checkbox" data-split-target value="grok"><span>Grok (xAI)</span></label>
        </div>

        <div class="split-note">
          –î–ª—è –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —ç—Ç–æ best effort: IP –±—ç–∫–µ–Ω–¥–æ–≤ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è, –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥. –í WireSock –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–≥—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è <code>AllowedProcesses</code> ‚Äî —Ç—Ä–∞—Ñ–∏–∫ –Ω—É–∂–Ω—ã—Ö .exe —Ç—É–Ω–Ω–µ–ª–∏—Ä—É–µ—Ç—Å—è —Ç–æ—á–Ω–æ, –¥–∞–∂–µ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ IP.
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button class="btn-generate" id="generateBtn" onclick="generate()" style="flex:1">
        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
      </button>
      <button onclick="resetDefaults()" title="–°–±—Ä–æ—Å–∏—Ç—å –∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º" style="padding:14px 16px; background:rgba(255,255,255,0.05); border:1px solid var(--border);
               border-radius:10px; color:var(--muted); font-family:inherit; font-size:13px;
               cursor:pointer; white-space:nowrap; transition:background .2s;"
        onmouseover="this.style.background='rgba(255,255,255,0.09)'"
        onmouseout="this.style.background='rgba(255,255,255,0.05)'">
        ‚Ü∫ –°–±—Ä–æ—Å
      </button>
    </div>

    <div class="error-box" id="errorBox"></div>
  </div>

  <div class="card" id="secret-card" style="display:none;">
    <div class="card-title">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>

    <div class="field">
      <label>–ü—Ä–æ–≤–µ—Ä–∫–∞ WARP+ –∫–ª—é—á–∞</label>
      <div style="display:flex; gap:10px;">
        <input type="text" id="secretLicenseKey" placeholder="XXXXXXXX-XXXXXXXX-XXXXXXXX" style="flex:1">
        <button class="btn-copy" id="secretGenBtn" onclick="generateTestLicense()" style="width:220px; padding: 11px 16px;">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å TEST –∫–ª—é—á
        </button>
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button class="btn-generate" id="secretCheckBtn" onclick="checkSecretLicense()" style="flex:1">
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á
      </button>
    </div>

    <div class="status-pill" id="secretStatus"></div>

    <div class="secret-note" style="margin-top: 15px;">
      –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ª–µ–≥–∞–ª—å–Ω—ã–π FREE –∫–ª—é—á —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API Cloudflare, –∑–∞—Ç–µ–º –µ–≥–æ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
    </div>
  </div>

  <div class="card" id="result-card">
    <div class="result-header">
      <div class="card-title" style="margin:0">–ì–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥</div>
      <span class="badge" id="accountBadge"></span>
    </div>
    <textarea id="config-output" readonly spellcheck="false"></textarea>
    <div class="btn-row">
      <button class="btn-dl" onclick="download()">‚¨á –°–∫–∞—á–∞—Ç—å .conf</button>
      <button class="btn-copy" id="copyBtn" onclick="copyConfig()">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn-qr" id="qrBtn" onclick="showQR()" title="QR-–∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞">&#9636; QR</button>
    </div>

    <div id="qr-modal" onclick="if(event.target===this)closeQrModal()">
      <div class="qr-modal-box">
        <div class="qr-modal-title">QR-–∫–æ–¥ –∫–æ–Ω—Ñ–∏–≥–∞</div>
        <div class="qr-modal-sub">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –≤ AmneziaWG –∏–ª–∏ WireGuard</div>
        <img id="qr-img" style="display:none; border-radius:8px;" alt="QR-–∫–æ–¥ –∫–æ–Ω—Ñ–∏–≥–∞">
        <div id="qr-modal-error" style="display:none; color:var(--danger); font-size:12px; margin-top:10px;"></div>
        <div class="qr-modal-close" onclick="closeQrModal()">‚úï –ó–∞–∫—Ä—ã—Ç—å</div>
      </div>
    </div>
    <div class="status-pill" id="statusPill"></div>
    <details class="dns-miss-spoiler" id="dnsMissSpoiler" style="display:none;">
      <summary>–ü–æ–∫–∞–∑–∞—Ç—å DNS miss –¥–æ–º–µ–Ω—ã</summary>
      <div class="dns-miss-note">–≠—Ç–∏ –¥–æ–º–µ–Ω—ã –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–∑–æ–ª–≤–∏—Ç—å –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –ø–æ—ç—Ç–æ–º—É –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –Ω–∏—Ö –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
      <ul class="dns-miss-list" id="dnsMissList"></ul>
    </details>
  </div>

  <div class="card" id="history-card">
    <div class="history-header">
      <div class="card-title" style="margin:0">–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤</div>
      <button class="history-btn history-btn-del" onclick="clearHistory()" style="font-size:12px; padding:4px 10px;">‚úï –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>
    <div class="history-list" id="history-list"></div>
  </div>

  <footer>
    <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
      <button type="button" class="split-tool-btn" onclick="downloadClientApp('wireguard')">–°–∫–∞—á–∞—Ç—å WireGuard</button>
      <button type="button" class="split-tool-btn" onclick="downloadClientApp('amnezia')">–°–∫–∞—á–∞—Ç—å Amnezia</button>
      <button type="button" class="split-tool-btn" onclick="downloadClientApp('clash_verge')">–°–∫–∞—á–∞—Ç—å Clash Verge</button>
      <button type="button" class="split-tool-btn" onclick="downloadClientApp('wiresock')">–°–∫–∞—á–∞—Ç—å WireSock</button>
    </div>
    <div class="split-note" id="downloadHint" style="text-align:center; margin-top:8px;">
      –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ proxy –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
    </div>
    <div class="faq-block">
      <div class="faq-title">FAQ / –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
      <details class="faq-item">
        <summary>–ö–∞–∫–æ–π —Ç–∏–ø –∫–æ–Ω—Ñ–∏–≥–∞ –≤—ã–±—Ä–∞—Ç—å?</summary>
        <div class="faq-text">
          <strong>Amnezia</strong> ‚Äî –¥–ª—è AmneziaVPN/AmneziaWG —Å –æ–±—Ñ—É—Å–∫–∞—Ü–∏–µ–π. <strong>WireGuard</strong> ‚Äî –≤–∞–Ω–∏–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç.
          <strong>WireSock</strong> ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω blacklist/direct –∏ Protocol masking.
        </div>
      </details>
      <details class="faq-item">
        <summary>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä endpoint?</summary>
        <div class="faq-text">
          –ù–∞–∂–º–∏—Ç–µ <strong>‚ö° –ü–æ–¥–æ–±—Ä–∞—Ç—å endpoint –ª–æ–∫–∞–ª—å–Ω–æ</strong> ‚Äî —Å–∫–∞—á–∞–µ—Ç—Å—è <code>.bat</code>-—Ñ–∞–π–ª.
          –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º (—Ç–æ–ª—å–∫–æ Windows). –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç
          <strong>CloudflareWarpSpeedTest</strong>, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ WARP IP —Å –≤–∞—à–µ–π —Å–µ—Ç–∏
          (–∑–∞–¥–µ—Ä–∂–∫–∞, –ø–æ—Ç–µ—Ä–∏ –ø–∞–∫–µ—Ç–æ–≤) –∏ –≤—ã–±–µ—Ä–µ—Ç –ª—É—á—à–∏–π. –ï—Å–ª–∏ WARP-–ø–æ—Ä—Ç—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã DPI ‚Äî
          –ø–æ–ø—Ä–æ–±—É–µ—Ç –æ–±—Ö–æ–¥ —á–µ—Ä–µ–∑ <strong>zapret/winws</strong> (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞).
          –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (1‚Äì3 –º–∏–Ω) –ª—É—á—à–∏–π endpoint –∏ –ø–æ—Ä—Ç –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –≤ —Ñ–æ—Ä–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî
          –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥¬ª.
        </div>
      </details>
      <details class="faq-item">
        <summary>–ü–æ—á–µ–º—É split tunnel –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã?</summary>
        <div class="faq-text">
          –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ IP/CIDR. –£ —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ—Å–æ–±–µ–Ω–Ω–æ –∏–≥—Ä–æ–≤—ã—Ö –∏ CDN) IP —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ
          –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Å–ø–∏—Å–∫–µ.
        </div>
      </details>
      <details class="faq-item">
        <summary>–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è?</summary>
        <div class="faq-text">
          –ö–Ω–æ–ø–∫–∏ —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç proxy, –∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ –æ—Ç–∫—Ä–æ—é—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∑–∫–∏.
          –î–ª—è WireSock –Ω–∞ macOS/Linux/iOS/Android –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π download page.
        </div>
      </details>
    </div>
    <div class="version-line">–í–µ—Ä—Å–∏—è: <span id="siteVersion">loading...</span></div>
  </footer>

  <script>
    let lastGeneratedConfigType = 'amnezia';
    let secretTapCount = 0;
    let secretTapTimer = null;
    let warpOptionsLoaded = false;
    let speedtestPollTimer = null;

    const SPLIT_PRESETS = {
      social: ['discord', 'youtube', 'x_com', 'instagram', 'twitch', 'telegram', 'whatsapp', 'viber', 'tiktok', 'ipcheck_2ip', 'speedtest', 'fast_com', 'whoer'],
      gaming: ['steam', 'faceit', 'apex_legends', 'ea_app', 'battle_net', 'cs2', 'hearthstone', 'pubg'],
      ai: ['chatgpt', 'claude_ai', 'gemini', 'grok'],
      ru_direct: ['geosite_ru'],
    };

    function addSelectOption(selectEl, value, label) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = label;
      selectEl.appendChild(option);
      return option;
    }

    async function loadWarpOptions() {
      const endpointPortSelect = document.getElementById('endpointPort');
      const endpointIpSelect = document.getElementById('endpointIp');
      try {
        const resp = await fetch('/api/warp-options', { cache: 'no-store' });
        const data = await resp.json();
        if (!resp.ok || !Array.isArray(data?.ports) || !Array.isArray(data?.endpointGroups)) {
          throw new Error('invalid_warp_options');
        }

        endpointPortSelect.innerHTML = '';
        data.ports.forEach((port) => {
          const isRecommended = Number(port) === Number(data.defaultPort || 2408);
          addSelectOption(
            endpointPortSelect,
            String(port),
            isRecommended ? `${port} ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è` : String(port),
          );
        });
        endpointPortSelect.value = String(data.defaultPort || 2408);

        endpointIpSelect.innerHTML = '';
        data.endpointGroups.forEach((group) => {
          const optGroup = document.createElement('optgroup');
          optGroup.label = group.label || 'Endpoints';
          (group.items || []).forEach((item) => {
            addSelectOption(optGroup, item.value, item.label || item.value);
          });
          endpointIpSelect.appendChild(optGroup);
        });
        endpointIpSelect.value = data.defaultEndpoint || 'auto';
        warpOptionsLoaded = true;
      } catch {
        if (!endpointPortSelect.options.length) {
          endpointPortSelect.innerHTML = '';
          addSelectOption(endpointPortSelect, '2408', '2408 ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è');
          endpointPortSelect.value = '2408';
        }
        if (!endpointIpSelect.options.length) {
          endpointIpSelect.innerHTML = '';
          addSelectOption(endpointIpSelect, 'auto', '–ê–≤—Ç–æ (engage.cloudflareclient.com)');
          endpointIpSelect.value = 'auto';
        }
        warpOptionsLoaded = false;
      }
    }

    function getSelectedConfigType() {
      const value = document.getElementById('configType').value;
      if (value === 'wiresock') return 'wiresock';
      return value === 'wireguard' ? 'wireguard' : 'amnezia';
    }

    function updateConfigTypeVisibility() {
      const selectedType = getSelectedConfigType();
      const isAmnezia = selectedType === 'amnezia';
      const isWiresock = selectedType === 'wiresock';
      document.querySelectorAll('.amnezia-only').forEach((el) => {
        el.style.display = isAmnezia ? '' : 'none';
      });
      document.querySelectorAll('.wiresock-only').forEach((el) => {
        el.style.display = isWiresock ? '' : 'none';
      });
      const connectionGrid = document.getElementById('connectionGrid');
      connectionGrid.style.gridTemplateColumns = isAmnezia ? '' : '1fr';
    }

    function getSplitCheckboxes() {
      return Array.from(document.querySelectorAll('input[data-split-target]'));
    }

    function getSelectedSplitTargets() {
      return getSplitCheckboxes().filter((el) => el.checked).map((el) => el.value);
    }

    function setSelectedSplitTargets(targets) {
      const set = new Set(targets || []);
      getSplitCheckboxes().forEach((el) => {
        el.checked = set.has(el.value);
      });
    }

    function applySplitPreset(kind) {
      if (kind === 'clear') {
        setSelectedSplitTargets([]);
        return;
      }
      if (kind === 'all') {
        setSelectedSplitTargets(getSplitCheckboxes().map((el) => el.value));
        return;
      }
      setSelectedSplitTargets(SPLIT_PRESETS[kind] || []);
    }

    function updateSplitTargetsVisibility() {
      const wrap = document.getElementById('splitTargetsWrap');
      const mode = document.getElementById('splitMode').value;
      wrap.style.display = (mode === 'selective' || mode === 'blacklist') ? 'block' : 'none';
    }

    function detectClientPlatform() {
      const ua = navigator.userAgent.toLowerCase();
      const p = navigator.platform.toLowerCase();
      if (ua.includes('android')) return 'android';
      if (/iphone|ipad|ipod/.test(ua)) return 'ios';
      if (p.includes('mac')) return 'macos';
      if (p.includes('win')) return 'windows';
      if (p.includes('linux')) return 'linux';
      return 'windows';
    }

    function setDownloadHint(text) {
      const el = document.getElementById('downloadHint');
      if (el) el.textContent = text;
    }

    async function downloadClientApp(app) {
      const platform = detectClientPlatform();
      const directOpenLinks = {
        wireguard: {
          windows: 'https://download.wireguard.com/windows-client/wireguard-installer.exe',
          macos: 'https://apps.apple.com/us/app/wireguard/id1451685025',
          ios: 'https://apps.apple.com/us/app/wireguard/id1451685025',
          android: 'https://play.google.com/store/apps/details?id=com.wireguard.android',
        },
        wiresock: {
          windows: 'https://www.wiresock.net/wiresock-secure-connect/download',
          macos: 'https://www.wiresock.net/downloads/',
          linux: 'https://www.wiresock.net/downloads/',
          android: 'https://www.wiresock.net/downloads/',
          ios: 'https://www.wiresock.net/downloads/',
        },
      };
      const defaultFileNames = {
        wireguard: {
          windows: 'wireguard-installer.exe',
          macos: 'wireguard-macos.dmg',
          linux: 'wireguard-linux',
          android: 'wireguard-android.apk',
          ios: 'wireguard-ios',
        },
        amnezia: {
          windows: 'amnezia-windows.exe',
          macos: 'amnezia-macos.pkg',
          linux: 'amnezia-linux.tar',
          android: 'amnezia-android.apk',
          ios: 'amnezia-ios',
        },
        clash_verge: {
          windows: 'clash-verge-windows.exe',
          macos: 'clash-verge-macos.dmg',
          linux: 'clash-verge-linux.deb',
          android: 'clash-verge-android.apk',
          ios: 'clash-verge-ios',
        },
        wiresock: {
          windows: 'wiresock-windows.msi',
          macos: 'wiresock-macos',
          linux: 'wiresock-linux',
          android: 'wiresock-android',
          ios: 'wiresock-ios',
        },
      };
      const directUrl = directOpenLinks[app]?.[platform];
      if (directUrl) {
        window.open(directUrl, '_blank', 'noopener,noreferrer');
        if (app === 'wiresock') {
          setDownloadHint('WireSock –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –ø–æ–¥ Windows. –û—Ç–∫—Ä—ã—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–æ–∫.');
        } else {
          setDownloadHint(`–û—Ç–∫—Ä—ã—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${app} –¥–ª—è ${platform}.`);
        }
        return;
      }

      const url = `/api/client-download/${encodeURIComponent(app)}?platform=${encodeURIComponent(platform)}`;
      setDownloadHint(`–ó–∞–ø—Ä–∞—à–∏–≤–∞—é ${app} –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã ${platform} —á–µ—Ä–µ–∑ proxy...`);
      try {
        const resp = await fetch(url, { method: 'GET' });
        if (!resp.ok) throw new Error(`Download error ${resp.status}`);
        const contentType = String(resp.headers.get('content-type') || '').toLowerCase();
        if (contentType.includes('text/html')) {
          const fallback = directOpenLinks[app]?.[platform];
          if (fallback) {
            window.open(fallback, '_blank', 'noopener,noreferrer');
            setDownloadHint(`Proxy –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞. –û—Ç–∫—Ä—ã—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${app}.`);
            return;
          }
        }
        const blob = await resp.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objectUrl;
        const defaultName = defaultFileNames[app]?.[platform] || `${app}-${platform}`;
        const cd = resp.headers.get('content-disposition') || '';
        const fileMatch = cd.match(/filename=\"?([^\";]+)\"?/i);
        a.download = fileMatch?.[1] || defaultName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(objectUrl);
        setDownloadHint(`–°–∫–∞—á–∞–Ω–æ: ${a.download || defaultName}`);
      } catch (err) {
        setDownloadHint(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ proxy: ${err.message}`);
      }
    }

    function renderDnsMiss(unresolvedDomains) {
      const spoiler = document.getElementById('dnsMissSpoiler');
      const list = document.getElementById('dnsMissList');
      const domains = Array.isArray(unresolvedDomains)
        ? unresolvedDomains.filter((d) => typeof d === 'string' && d.trim())
        : [];

      list.innerHTML = '';
      if (!domains.length) {
        spoiler.style.display = 'none';
        spoiler.open = false;
        return;
      }

      domains.forEach((domain) => {
        const item = document.createElement('li');
        item.textContent = domain;
        list.appendChild(item);
      });
      spoiler.style.display = 'block';
      spoiler.open = false;
    }

    async function loadVersion() {
      const el = document.getElementById('siteVersion');
      try {
        const resp = await fetch('/api/version', { cache: 'no-store' });
        const data = await resp.json();
        if (!resp.ok || !data?.display) throw new Error('version_unavailable');
        el.textContent = `v${data.display}`;
      } catch {
        el.textContent = 'unavailable';
      }
    }

    function toggleSecretCard(forceShow = null) {
      const card = document.getElementById('secret-card');
      const shouldShow = forceShow === null ? card.style.display === 'none' : !!forceShow;
      card.style.display = shouldShow ? 'block' : 'none';
      if (shouldShow) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function handleLogoSecretTap() {
      secretTapCount += 1;
      if (secretTapTimer) clearTimeout(secretTapTimer);
      secretTapTimer = setTimeout(() => {
        secretTapCount = 0;
      }, 3500);
      if (secretTapCount >= 7) {
        secretTapCount = 0;
        toggleSecretCard();
      }
    }

    async function checkSecretLicense() {
      const key = document.getElementById('secretLicenseKey').value.trim();
      const btn = document.getElementById('secretCheckBtn');
      const status = document.getElementById('secretStatus');
      status.textContent = '';
      if (!key) {
        status.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.';
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
      try {
        const resp = await fetch('/api/check-license', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ licenseKey: key }),
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
          throw new Error(data.error || `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${resp.status}`);
        }
        const verdict = data.valid ? '–≤–∞–ª–∏–¥–Ω—ã–π' : '–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π';
        const accountType = data.accountType || 'unknown';
        const referral = typeof data.referralCount === 'number' ? ` ¬∑ referrals: ${data.referralCount}` : '';
        const reason = data.message ? ` ¬∑ ${data.message}` : '';
        status.textContent = `–ö–ª—é—á ${verdict} ¬∑ type: ${accountType}${referral}${reason}`;
      } catch (err) {
        status.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á';
      }
    }

    async function generateTestLicense() {
      const btn = document.getElementById('secretGenBtn');
      const status = document.getElementById('secretStatus');
      const keyInput = document.getElementById('secretLicenseKey');
      status.textContent = '';

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...';
      try {
        const resp = await fetch('/api/generate-test-license', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
          throw new Error(data.error || `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${resp.status}`);
        }

        if (!data.license) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á.');
        }

        keyInput.value = data.license;
        const type = data.accountType || 'free';
        status.textContent = `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω TEST –∫–ª—é—á ¬∑ type: ${type} ¬∑ –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞...`;
        await checkSecretLicense();
      } catch (err) {
        status.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å TEST –∫–ª—é—á';
      }
    }

    function setLocalSpeedtestHint(text) {
      const hint = document.getElementById('localSpeedtestHint');
      hint.textContent = text;
    }

    function applyBestEndpoint(bestEndpoint) {
      if (typeof bestEndpoint !== 'string') return;
      const clean = bestEndpoint.trim();
      const idx = clean.lastIndexOf(':');
      if (idx <= 0) return;
      const ip = clean.slice(0, idx);
      const port = clean.slice(idx + 1);
      const endpointIpSelect = document.getElementById('endpointIp');
      const endpointPortSelect = document.getElementById('endpointPort');
      endpointIpSelect.value = ip;
      endpointPortSelect.value = port;
    }

    async function pollSpeedtestSession(pollPath) {
      if (speedtestPollTimer) {
        clearInterval(speedtestPollTimer);
        speedtestPollTimer = null;
      }
      const runCheck = async () => {
        try {
          const resp = await fetch(pollPath, { cache: 'no-store' });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || `poll_error_${resp.status}`);
          }
          if (data.status === 'completed' && data.result?.bestEndpoint) {
            applyBestEndpoint(data.result.bestEndpoint);
            setLocalSpeedtestHint(`‚úÖ –ù–∞–π–¥–µ–Ω –ª—É—á—à–∏–π endpoint: ${data.result.bestEndpoint}. –ü–æ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`);
            renderSpeedtestResults(data.result);
            if (speedtestPollTimer) {
              clearInterval(speedtestPollTimer);
              speedtestPollTimer = null;
            }
          }
        } catch {
          // keep polling
        }
      };

      await runCheck();
      speedtestPollTimer = setInterval(runCheck, 3000);
      setTimeout(() => {
        if (speedtestPollTimer) {
          clearInterval(speedtestPollTimer);
          speedtestPollTimer = null;
          setLocalSpeedtestHint('–°–µ—Å—Å–∏—è speedtest –∏—Å—Ç–µ–∫–ª–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.');
        }
      }, 20 * 60 * 1000);
    }

    function renderSpeedtestResults(result) {
      const container = document.getElementById('speedtest-results');
      if (!container) return;
      const rows = Array.isArray(result.topResults) ? result.topResults : [];
      const sourceLabel = {
        'windows-local-helper': '–ø—Ä—è–º–æ–π —Å–∫–∞–Ω',
        'windows-local-helper-quality': 'quality pass',
        'windows-local-helper-dpi-bypass': 'DPI bypass',
        'windows-local-helper-fallback': 'fallback',
        'macos-local-helper': '–ø—Ä—è–º–æ–π —Å–∫–∞–Ω (macOS)',
        'macos-local-helper-fallback': 'fallback (macOS)',
      }[result.source] || result.source || '';
      let html = `<div class="speedtest-results-title">–¢–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã speedtest</div>`;
      if (rows.length > 0) {
        html += `<table class="speedtest-results-table"><thead><tr><th>#</th><th>Endpoint</th><th>Loss</th><th>Latency</th></tr></thead><tbody>`;
        rows.forEach((r, i) => {
          const ep = r.endpoint || r['IP:Port'] || '';
          const loss = r.loss !== undefined ? r.loss : (r.Loss || '');
          const lat = r.latencyMs !== undefined ? r.latencyMs : (r.Latency || '');
          html += `<tr><td>${i + 1}</td><td>${ep}</td><td>${typeof loss === 'number' ? loss.toFixed(1) + '%' : loss}</td><td>${typeof lat === 'number' ? lat.toFixed(0) + 'ms' : lat}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      const tags = [];
      if (sourceLabel) tags.push(sourceLabel);
      if (result.dpiProfile) tags.push(`–ø—Ä–æ—Ñ–∏–ª—å: ${result.dpiProfile}`);
      if (tags.length) html += `<div class="speedtest-source-tag">${tags.join(' ¬∑ ')}</div>`;
      html += `<div style="margin-top:10px;"><button type="button" class="speedtest-btn" style="font-size:13px; padding:9px 14px;" onclick="generate()">‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ —Å —ç—Ç–∏–º endpoint</button></div>`;
      container.innerHTML = html;
      container.style.display = 'block';
    }

    const isMacOS = /Mac/.test(navigator.platform) || /Macintosh|Mac OS X/.test(navigator.userAgent);
    const isWindows = /Win/.test(navigator.platform) || /Windows/.test(navigator.userAgent);

    function initSpeedtestPlatformUI() {
      if (isMacOS && !isWindows) {
        document.getElementById('speedtest-steps-win').style.display = 'none';
        document.getElementById('speedtest-steps-mac').style.display = '';
        document.getElementById('speedtest-detail-win').style.display = 'none';
        document.getElementById('speedtest-detail-mac').style.display = '';
        document.getElementById('dpiFirstToggle').style.display = 'none';
        document.getElementById('extendedStrategyToggle').style.display = 'none';
      }
    }

    async function startLocalSpeedtest() {
      const btn = document.getElementById('localSpeedtestBtn');
      const dpiFirst = document.getElementById('dpiFirstMode')?.checked || false;
      const extendedStrategy = document.getElementById('speedtestExtendedMode')?.checked !== false;
      const useMac = isMacOS && !isWindows;
      btn.disabled = true;
      btn.textContent = '‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
      try {
        if (!warpOptionsLoaded) {
          await loadWarpOptions();
        }
        const sessionResp = await fetch('/api/speedtest/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dpiFirst: useMac ? false : dpiFirst, extendedStrategy }),
        });
        const sessionData = await sessionResp.json();
        if (!sessionResp.ok || !sessionData.pollPath) {
          throw new Error(sessionData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å speedtest-—Å–µ—Å—Å–∏—é.');
        }

        let downloadPath, fileName;
        if (useMac && sessionData.downloadShPath) {
          downloadPath = sessionData.downloadShPath;
          fileName = `warp-speedtest-${sessionData.sessionId}.sh`;
        } else if (sessionData.downloadBatPath) {
          downloadPath = sessionData.downloadBatPath;
          fileName = `run-warp-speedtest-${sessionData.sessionId}.bat`;
        } else {
          downloadPath = sessionData.downloadPath;
          fileName = `warp-speedtest-${sessionData.sessionId}.ps1`;
        }

        const scriptResp = await fetch(downloadPath, { cache: 'no-store' });
        if (!scriptResp.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Å–∫—Ä–∏–ø—Ç (${scriptResp.status}).`);
        const scriptText = await scriptResp.text();
        const blob = new Blob([scriptText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        if (useMac) {
          setLocalSpeedtestHint(`‚úÖ –°–∫—Ä–∏–ø—Ç —Å–∫–∞—á–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –¢–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: bash ~/Downloads/${fileName}`);
        } else if (dpiFirst) {
          setLocalSpeedtestHint(`‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω (DPI-—Ä–µ–∂–∏–º${extendedStrategy ? ', extended' : ''}). –ó–∞–ø—É—Å—Ç–∏—Ç–µ .bat –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.`);
        } else {
          setLocalSpeedtestHint(`‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω${extendedStrategy ? ' (extended)' : ''}. –ó–∞–ø—É—Å—Ç–∏—Ç–µ .bat –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º ‚Äî endpoint –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
        }
        await pollSpeedtestSession(sessionData.pollPath);
      } catch (err) {
        setLocalSpeedtestHint(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ö° –ü–æ–¥–æ–±—Ä–∞—Ç—å endpoint –ª–æ–∫–∞–ª—å–Ω–æ';
      }
    }

    // ‚îÄ‚îÄ localStorage: form settings ‚îÄ‚îÄ
    const LS_SETTINGS_KEY = 'warpgen_form_v1';
    const LS_HISTORY_KEY  = 'warpgen_history_v1';

    function saveFormSettings() {
      try {
        const settings = {
          configType: document.getElementById('configType').value,
          obfsProfile: document.getElementById('obfsProfile').value,
          endpointPort: document.getElementById('endpointPort').value,
          endpointIp: document.getElementById('endpointIp').value,
          quicPreset: document.getElementById('quicPreset').value,
          dnsServer: document.getElementById('dnsServer').value,
          splitMode: document.getElementById('splitMode').value,
          splitTargets: getSelectedSplitTargets(),
          protocolMaskingEnabled: document.getElementById('protocolMaskingEnabled').value,
          protocolMaskId: document.getElementById('protocolMaskId').value.trim(),
          protocolMaskIp: document.getElementById('protocolMaskIp').value,
          protocolMaskIb: document.getElementById('protocolMaskIb').value,
        };
        localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
      } catch (_) {}
    }

    function restoreFormSettings() {
      try {
        const raw = localStorage.getItem(LS_SETTINGS_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el && val !== undefined && val !== null) el.value = val;
        };
        setVal('configType', s.configType);
        setVal('obfsProfile', s.obfsProfile);
        setVal('endpointPort', s.endpointPort);
        setVal('endpointIp', s.endpointIp);
        setVal('quicPreset', s.quicPreset);
        setVal('dnsServer', s.dnsServer);
        setVal('splitMode', s.splitMode);
        setVal('protocolMaskingEnabled', s.protocolMaskingEnabled);
        setVal('protocolMaskId', s.protocolMaskId);
        setVal('protocolMaskIp', s.protocolMaskIp);
        setVal('protocolMaskIb', s.protocolMaskIb);
        if (Array.isArray(s.splitTargets)) setSelectedSplitTargets(s.splitTargets);
        updateConfigTypeVisibility();
        updateSplitTargetsVisibility();
      } catch (_) {}
    }

    // ‚îÄ‚îÄ localStorage: config history ‚îÄ‚îÄ
    function saveConfigHistory(data) {
      try {
        let history = [];
        const raw = localStorage.getItem(LS_HISTORY_KEY);
        if (raw) history = JSON.parse(raw);
        const entry = {
          ts: Date.now(),
          date: new Date().toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }),
          configType: data.configType || 'amnezia',
          endpoint: data.endpoint || '',
          splitMode: data.splitTunnel?.mode || 'full',
          config: data.config || '',
        };
        history.unshift(entry);
        if (history.length > 5) history = history.slice(0, 5);
        localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
        renderConfigHistory();
      } catch (_) {}
    }

    function renderConfigHistory() {
      try {
        const raw = localStorage.getItem(LS_HISTORY_KEY);
        const card = document.getElementById('history-card');
        const list = document.getElementById('history-list');
        if (!raw) { card.style.display = 'none'; return; }
        const history = JSON.parse(raw);
        if (!history.length) { card.style.display = 'none'; return; }
        const typeLabels = { amnezia: 'AmneziaWG', wireguard: 'WireGuard', wiresock: 'WireSock' };
        const splitLabels = { full: 'Full', selective: 'Split', blacklist: 'Blacklist' };
        list.innerHTML = history.map((e, i) => {
          const tagHtml = e.tag ? `<span class="history-tag">${escHtml(e.tag)}</span>` : '';
          const title = `${typeLabels[e.configType] || e.configType} ¬∑ ${e.endpoint} ¬∑ ${splitLabels[e.splitMode] || e.splitMode}`;
          return `
          <div class="history-item">
            <div class="history-item-meta">
              <div class="history-item-title">${tagHtml}<span>${escHtml(title)}</span></div>
              <div class="history-item-date">${e.date}</div>
            </div>
            <div class="history-actions">
              <span class="history-btn" onclick="setHistoryTag(${i})" title="–ó–∞–¥–∞—Ç—å —Ç–µ–≥">‚úè</span>
              <span class="history-btn history-btn-del" onclick="deleteHistoryEntry(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</span>
              <span class="history-btn history-btn-restore" onclick="applyHistoryEntry(${i})">‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>
            </div>
          </div>`;
        }).join('');
        card.style.display = 'block';
      } catch (_) {}
    }

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function applyHistoryEntry(index) {
      try {
        const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
        const entry = history[index];
        if (!entry) return;
        document.getElementById('config-output').value = entry.config;
        lastGeneratedConfigType = entry.configType;
        document.getElementById('result-card').style.display = 'block';
        document.getElementById('result-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (_) {}
    }

    function setHistoryTag(index) {
      try {
        const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
        if (!history[index]) return;
        const current = history[index].tag || '';
        const tag = prompt('–¢–µ–≥ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å):', current);
        if (tag === null) return; // cancelled
        history[index].tag = tag.trim().slice(0, 32);
        localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
        renderConfigHistory();
      } catch (_) {}
    }

    function deleteHistoryEntry(index) {
      try {
        const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
        history.splice(index, 1);
        localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
        renderConfigHistory();
      } catch (_) {}
    }

    function clearHistory() {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ñ–∏–≥–æ–≤?')) return;
      localStorage.removeItem(LS_HISTORY_KEY);
      renderConfigHistory();
    }

    // ‚îÄ‚îÄ Generate ‚îÄ‚îÄ
    async function generate() {
      const btn = document.getElementById('generateBtn');
      const errBox = document.getElementById('errorBox');
      const resultCard = document.getElementById('result-card');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...';
      errBox.style.display = 'none';
      resultCard.style.display = 'none';
      renderDnsMiss([]);

      try {
        const resp = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            licenseKey: document.getElementById('licenseKey').value.trim(),
            configType: getSelectedConfigType(),
            obfsProfile: document.getElementById('obfsProfile').value,
            endpointPort: document.getElementById('endpointPort').value,
            endpointIp: document.getElementById('endpointIp').value,
            quicPreset: document.getElementById('quicPreset').value,
            dnsServer: document.getElementById('dnsServer').value,
            splitMode: document.getElementById('splitMode').value,
            splitTargets: getSelectedSplitTargets(),
            protocolMaskingEnabled: document.getElementById('protocolMaskingEnabled').value === '1',
            protocolMaskId: document.getElementById('protocolMaskId').value.trim(),
            protocolMaskIp: document.getElementById('protocolMaskIp').value,
            protocolMaskIb: document.getElementById('protocolMaskIb').value,
          }),
        });

        const data = await resp.json();

        if (!resp.ok || data.error) {
          throw new Error(data.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`);
        }

        document.getElementById('config-output').value = data.config;
        if (data.configType === 'wireguard') lastGeneratedConfigType = 'wireguard';
        else if (data.configType === 'wiresock') lastGeneratedConfigType = 'wiresock';
        else lastGeneratedConfigType = 'amnezia';

        const badge = document.getElementById('accountBadge');
        if (data.accountType === 'warp_plus' || data.accountType === 'unlimited') {
          badge.textContent = 'WARP+';
          badge.className = 'badge badge-plus';
        } else {
          badge.textContent = 'Free';
          badge.className = 'badge badge-free';
        }

        const configTitle = lastGeneratedConfigType === 'wireguard'
          ? 'WireGuard'
          : lastGeneratedConfigType === 'wiresock'
            ? 'WireSock'
            : 'Amnezia';
        let statusText = `Endpoint: ${data.endpoint} ¬∑ ${configTitle}`;
        if (data.licenseError) statusText += ` ¬∑ ‚ö† –ö–ª—é—á: ${data.licenseError}`;
        if (data.splitTunnel?.mode === 'selective') {
          const selectedCount = data.splitTunnel.selectedTargets?.length || 0;
          const routeCount = data.splitTunnel.resolvedAllowedIps || 0;
          const unresolvedCount = data.splitTunnel.unresolvedDomains?.length || 0;
          statusText += ` ¬∑ Split: ${selectedCount} —Å–µ—Ä–≤–∏—Å–æ–≤ / ${routeCount} –º–∞—Ä—à—Ä—É—Ç–æ–≤`;
          if (unresolvedCount) statusText += ` ¬∑ DNS miss: ${unresolvedCount}`;
        }
        if (data.splitTunnel?.mode === 'blacklist') {
          const selectedCount = data.splitTunnel.selectedTargets?.length || 0;
          const routeCount = data.splitTunnel.disallowedIps || data.splitTunnel.resolvedAllowedIps || 0;
          const unresolvedCount = data.splitTunnel.unresolvedDomains?.length || 0;
          statusText += ` ¬∑ Blacklist: ${selectedCount} —Å–µ—Ä–≤–∏—Å–æ–≤ / ${routeCount} direct-–∏—Å–∫–ª—é—á–µ–Ω–∏–π`;
          if (unresolvedCount) statusText += ` ¬∑ DNS miss: ${unresolvedCount}`;
        }
        renderDnsMiss(data.splitTunnel?.unresolvedDomains || []);
        document.getElementById('statusPill').textContent = statusText;
        resultCard.style.display = 'block';
        resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        saveFormSettings();
        saveConfigHistory(data);

      } catch (err) {
        errBox.textContent = '‚ö† ' + err.message;
        errBox.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥';
      }
    }

    // ‚îÄ‚îÄ Download ‚îÄ‚îÄ
    function download() {
      const text = document.getElementById('config-output').value;
      const a = document.createElement('a');
      a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
      a.download = lastGeneratedConfigType === 'wireguard'
        ? 'WARP_WireGuard.conf'
        : lastGeneratedConfigType === 'wiresock'
          ? 'WARP_WireSock.conf'
        : 'WARP_AmneziaWG.conf';
      a.click();
    }

    // ‚îÄ‚îÄ Copy ‚îÄ‚îÄ
    async function copyConfig() {
      const text = document.getElementById('config-output').value;
      const btn = document.getElementById('copyBtn');
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => { btn.textContent = '‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
      } catch {
        btn.textContent = '–û—à–∏–±–∫–∞ :(';
      }
    }

    // ‚îÄ‚îÄ Reset to defaults ‚îÄ‚îÄ
    function resetDefaults() {
      document.getElementById('licenseKey').value = '';
      document.getElementById('configType').value = 'amnezia';
      document.getElementById('obfsProfile').value = '1';
      document.getElementById('endpointPort').value = '2408';
      document.getElementById('endpointIp').value = 'auto';
      document.getElementById('dnsServer').value = 'malw_link';
      document.getElementById('quicPreset').value = 'yandex';
      document.getElementById('splitMode').value = 'full';
      document.getElementById('protocolMaskingEnabled').value = '0';
      document.getElementById('protocolMaskId').value = 'lenta.ru';
      document.getElementById('protocolMaskIp').value = 'quic';
      document.getElementById('protocolMaskIb').value = 'firefox';
      lastGeneratedConfigType = 'amnezia';
      setSelectedSplitTargets([]);
      updateConfigTypeVisibility();
      updateSplitTargetsVisibility();
      if (!warpOptionsLoaded) loadWarpOptions();
    }

    document.getElementById('configType').addEventListener('change', updateConfigTypeVisibility);
    document.getElementById('splitMode').addEventListener('change', updateSplitTargetsVisibility);
    document.getElementById('logoTrigger').addEventListener('click', handleLogoSecretTap);
    updateConfigTypeVisibility();
    updateSplitTargetsVisibility();
    loadWarpOptions().then(() => restoreFormSettings());
    loadVersion();
    initSpeedtestPlatformUI();
    renderConfigHistory();

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate();
      if (e.key === 'Escape') closeQrModal();
    });

    function closeQrModal() {
      document.getElementById('qr-modal').classList.remove('open');
    }

    async function showQR() {
      const config = document.getElementById('config-output').value;
      if (!config || !config.trim()) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥.');
        return;
      }
      const modal = document.getElementById('qr-modal');
      const imgEl = document.getElementById('qr-img');
      const errEl = document.getElementById('qr-modal-error');
      errEl.style.display = 'none';
      errEl.textContent = '';
      imgEl.style.display = 'none';
      modal.classList.add('open');
      try {
        const resp = await fetch('/api/qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: config.trim() }),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || `–û—à–∏–±–∫–∞ ${resp.status}`);
        imgEl.src = data.dataUrl;
        imgEl.style.display = 'block';
      } catch (e) {
        errEl.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR (${config.length} –±–∞–π—Ç): ${e.message}`;
        errEl.style.display = 'block';
      }
    }
  </script>
</body>

</html>
